// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ─── Multi-Tenancy Core ───────────────────────────────────────────────

model School {
  id             String           @id @default(cuid())
  name           String
  alias          String           @unique // e.g., "my-school"
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  settings       SchoolSettings?
  users          User[]
  academicYears  AcademicYear[]
  students       Student[]
  employees      Employee[]
  classes        Class[]
  subjects       Subject[]
  feeStructures  FeeStructure[]
}

// ─── User Management ──────────────────────────────────────────────────

model User {
  id             String   @id @default(cuid())
  schoolId       String
  email          String   @unique
  password       String
  name           String?
  role           String   @default("student") // admin, teacher, student, parent
  phone          String?
  avatar         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  school         School   @relation(fields: [schoolId], references: [id])
}

// ─── School Settings ──────────────────────────────────────────────────

model SchoolSettings {
  id          String   @id @default(cuid())
  schoolId    String   @unique
  schoolName  String   @default("My School")
  tagline     String?
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  logo        String?
  favicon     String?
  website     String?
  currency    String   @default("BDT")
  timezone    String   @default("Asia/Dhaka")
  dateFormat  String   @default("DD/MM/YYYY")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school      School   @relation(fields: [schoolId], references: [id])
}

// ─── Academic Structure ───────────────────────────────────────────────

model AcademicYear {
  id        String   @id @default(cuid())
  schoolId  String
  name      String   // e.g., "2025-2026"
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school    School   @relation(fields: [schoolId], references: [id])
  classes   Class[]
  feeStructures FeeStructure[]
  exams     Exam[]
}

model Class {
  id             String   @id @default(cuid())
  schoolId       String
  name           String   // e.g., "Class 10"
  section        String?  // e.g., "A", "Morning"
  capacity       Int?
  classTeacherId String?
  academicYearId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  school         School   @relation(fields: [schoolId], references: [id])
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  classTeacher   Employee?    @relation("ClassTeacher", fields: [classTeacherId], references: [id])
  
  students       Student[]
  subjects       SubjectClass[]
  timetables     Timetable[]
  feeStructures  FeeStructure[]
  exams          Exam[]
  homework       Homework[]
}

model Subject {
  id        String   @id @default(cuid())
  schoolId  String
  name      String
  code      String?
  type      String   @default("theory") // theory, practical
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school    School   @relation(fields: [schoolId], references: [id])
  classes   SubjectClass[]
  timetables Timetable[]
  exams      ExamResult[]
  homework   Homework[]
}

model SubjectClass {
  id        String   @id @default(cuid())
  subjectId String
  classId   String
  teacherId String?

  subject   Subject  @relation(fields: [subjectId], references: [id])
  class     Class    @relation(fields: [classId], references: [id])
  teacher   Employee? @relation(fields: [teacherId], references: [id])

  @@unique([subjectId, classId])
}

// ─── People (Students & Employees) ────────────────────────────────────

model Student {
  id           String   @id @default(cuid())
  schoolId     String
  firstName    String
  lastName     String
  admissionNo  String   @unique
  rollNo       String?
  classId      String
  
  // Personal Details
  dateOfBirth  DateTime
  gender       String
  bloodGroup   String?
  religion     String?
  phone        String?
  email        String?
  address      String?
  city         String?
  state        String?
  
  // Guardian Details
  guardianName String?
  guardianPhone String?
  guardianRelation String?
  
  // System
  profilePic   String?
  status       String   @default("active") // active, transferred, graduated
  admissionDate DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  school       School   @relation(fields: [schoolId], references: [id])
  class        Class    @relation(fields: [classId], references: [id])
  
  attendance   Attendance[]
  feePayments  FeePayment[]
  examResults  ExamResult[]
  homeworkSubmissions HomeworkSubmission[]
}

model Employee {
  id           String   @id @default(cuid())
  schoolId     String
  employeeId   String   @unique
  firstName    String
  lastName     String
  designation  String   // Teacher, Principal, Accountant
  department   String?

  // Personal Details
  dateOfBirth  DateTime
  gender       String
  phone        String
  email        String   @unique
  address      String?
  city         String?
  qualification String?
  
  // Employment
  joiningDate  DateTime
  baseSalary   Float
  status       String   @default("active")
  
  // System
  profilePic   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  school       School   @relation(fields: [schoolId], references: [id])
  
  // Relations
  classesDocent Class[] @relation("ClassTeacher") // Classes where they are class teacher
  subjectClasses SubjectClass[]
  attendance    EmployeeAttendance[]
  salaryPayments SalaryPayment[]
  timetables    Timetable[]
  homework      Homework[]
}

// ─── Attendance ───────────────────────────────────────────────────────

model Attendance {
  id         String   @id @default(cuid())
  studentId  String
  classId    String
  date       DateTime
  status     String   // present, absent, late, leave
  remarks    String?
  createdAt  DateTime @default(now())

  student    Student  @relation(fields: [studentId], references: [id])

  @@unique([studentId, date])
}

model EmployeeAttendance {
  id         String   @id @default(cuid())
  employeeId String
  date       DateTime
  status     String   // present, absent, leave
  checkIn    String?
  checkOut   String?
  remarks    String?
  createdAt  DateTime @default(now())

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, date])
}

// ─── Fee Management ───────────────────────────────────────────────────

model FeeStructure {
  id             String       @id @default(cuid())
  schoolId       String
  name           String       // e.g., "Tuition Fee", "Lab Fee"
  amount         Float
  frequency      String       @default("monthly") // monthly, quarterly, yearly, one-time
  classId        String
  academicYearId String
  dueDay         Int          @default(10)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  school         School       @relation(fields: [schoolId], references: [id])
  class          Class        @relation(fields: [classId], references: [id])
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  payments       FeePayment[]
}

model FeePayment {
  id             String       @id @default(cuid())
  studentId      String
  feeStructureId String
  amount         Float
  paidAmount     Float        @default(0)
  discount       Float        @default(0)
  fine           Float        @default(0)
  month          Int          // 1-12
  year           Int
  status         String       @default("pending") // pending, paid, partial, overdue
  paymentDate    DateTime?
  paymentMethod  String?      // cash, bank, online
  receiptNo      String?
  remarks        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  student        Student      @relation(fields: [studentId], references: [id])
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id])
}

// ─── Salary Management ───────────────────────────────────────────────

model SalaryPayment {
  id           String   @id @default(cuid())
  employeeId   String
  month        Int
  year         Int
  baseSalary   Float
  allowances   Float    @default(0)
  deductions   Float    @default(0)
  netSalary    Float
  status       String   @default("pending") // pending, paid
  paymentDate  DateTime?
  paymentMethod String?
  remarks      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  employee     Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
}

// ─── Timetable ────────────────────────────────────────────────────────

model Timetable {
  id         String   @id @default(cuid())
  classId    String
  subjectId  String
  teacherId  String
  day        String   // Monday, Tuesday, etc.
  startTime  String   // "08:00"
  endTime    String   // "08:45"
  room       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  class      Class    @relation(fields: [classId], references: [id])
  subject    Subject  @relation(fields: [subjectId], references: [id])
  teacher    Employee @relation(fields: [teacherId], references: [id])
}

// ─── Homework ─────────────────────────────────────────────────────────

model Homework {
  id          String   @id @default(cuid())
  title       String
  description String?
  classId     String
  subjectId   String
  teacherId   String
  dueDate     DateTime
  attachments String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  class       Class    @relation(fields: [classId], references: [id])
  subject     Subject  @relation(fields: [subjectId], references: [id])
  teacher     Employee @relation(fields: [teacherId], references: [id])
  submissions HomeworkSubmission[]
}

model HomeworkSubmission {
  id         String   @id @default(cuid())
  homeworkId String
  studentId  String
  content    String?
  attachment String?
  grade      String?
  remarks    String?
  submittedAt DateTime @default(now())

  homework   Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id])

  @@unique([homeworkId, studentId])
}

// ─── Exams ────────────────────────────────────────────────────────────

model Exam {
  id             String       @id @default(cuid())
  name           String       // e.g., "Mid Term", "Final"
  type           String       @default("term") // term, class_test, quiz
  classId        String
  academicYearId String
  startDate      DateTime
  endDate        DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  class          Class        @relation(fields: [classId], references: [id])
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  results        ExamResult[]
}

model ExamResult {
  id         String   @id @default(cuid())
  examId     String
  studentId  String
  subjectId  String
  marksObtained Float
  totalMarks Float    @default(100)
  grade      String?
  remarks    String?
  createdAt  DateTime @default(now())

  exam       Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  student    Student  @relation(fields: [studentId], references: [id])
  subject    Subject  @relation(fields: [subjectId], references: [id])

  @@unique([examId, studentId, subjectId])
}
